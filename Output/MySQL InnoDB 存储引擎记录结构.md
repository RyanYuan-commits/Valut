---
type: permanent
---
# 🌐 核心观点

行格式是指数据库将表中的单行数据存储到磁盘上的物理格式.

---

# 🔖 详细解释

行格式是指数据库将表中的记录存储到磁盘上的物理格式, 目前 MySQL 中有四种行格式, 分别是 Compact, Redundant, Dynamic, Compressed, 可以通过如下方式制定:

## 1	Compact 行格式

![[InnoDB Compact 行格式.png]]

### 1.1	变长字段长度列表

MySQL 支持一些变长的数据类型, 如 VARCHAR(M), VARBINARY(M), 各种 TEXT 类型, 各种 BLOB 类型. 

变长数据的长度在 Compact 行格式中被存储在变长字段长度列表中.

每一个变长数据的长度使用一到两个字节来存储, 当字符集的最大字符长度乘类型的最大长度 ≤ 255 时, 使用 1 字节, 反之, 使用 2 字节.

变长字段长度列表按照变长列的顺序 **逆序** 存储, 值为 NULL 的变长列的长度不会被存储.

### 1.2	NULL 值列表

每个可能存储 NULL 值的列会对应 NULL 值列表中的一位, 同样是逆序排列, 为 NULL 存 1, 非 NULL 存 0.

### 1.3	记录头信息

|      名称      | bit |                            描述                             |
| :----------: | :-: | :-------------------------------------------------------: |
|     预留位1     |  1  |                           没有使用                            |
|     预留位2     |  1  |                           没有使用                            |
| delete_mask  |  1  |                        标记该记录是否被删除                         |
| min_rec_mask |  1  |                 B+树的每层非叶子节点中的最小记录都会添加该标记                  |
|   n_owned    |  4  |                       表示当前记录拥有的记录数                        |
|   heap_no    | 13  |                      表示当前记录在记录堆的位置信息                      |
| record_type  |  3  | 表示当前记录的类型, 0 表示普通记录, 1 表示 B+ 树非叶子节点记录, 2 表示最小记录, 3 表示最大记录 |
| next_record  | 16  |                       表示下一条记录的相对位置                        |

### 1.4	记录的真实数据

除了用户自己定义的列之外, MySQL 还会为每个记录默认的添加一些隐藏列.

**row_id** 是可选的, 仅在没有自定义主键和 Unique 键的情况下才会添加, InnoDB 表的主键生成策略如下:

1. 优先使用用户 **自定义主键** 作为主键.
	
2. 若无自定义主键, 则选取一个 **Unique 键**作为主键.
	
3. 若无 Unique 键, 则 InnoDB 会默认添加一个名为 **row_id 的隐藏列**作为主键.

## 2	Redunant 行格式

![[InnoDB Redunant 行格式.png]]

MySQL 5.0 之前使用的行格式.

### 2.1	字符长度偏移列表

Compact 行格式的开头是变长字段长度列表, Redundant 行格式的开头是字段长度偏移列表, 字段长度偏移列表与变长字段长度列表有两处不同:

1. **所有列的长度信息**(包括隐藏列)都按照**逆序**存储.
	
2. 采用**两个相邻数值的差值**来计算各个列值的长度.

### 2.2	记录头信息

- Redundant 行格式多了 n_field 和 1byte_offs_flag 两个属性.
    
- Redundant 行格式没有 record_type 属性.

## 3	行溢出数据

### 3.1	是什么?

MySQL 对一个记录的最大长度是有限制的, 最大是 65535 字节, 每个列除了其本身的数据长度之外, 还需要存储这个列的长度值和是否为 NULL (NOT NULL 不用存).

VARCHAR 最大可以占用 65535 字节, 一个页是 16 KB, 也就是 16384 字节, 无法存储一个 VARCHAR. 

在 Compact 和 Redundant 行格式中, 对于占用存储空间非常大的列, 在记录的真实数据处只会存储该列的一部分数据, 把剩余的数据分散存储在几个其他的页中, 然后记录的真实数据处用 20 个字节存储指向这些页的地址(当然这 20 个字节中还包括这些分散在其他页面中的数据的占用的字节数), 从而可以找到剩余数据所在的页.

### 3.2	行溢出的临界点

MySQL 规定一个页至少存放两条记录

- 页(Page)的额外信息占用 **132 字节**.
	
- 每条记录的额外信息占用 **27 字节**, 包括以下部分:

计算公式为: 132 + 2×(27 + n) < 16384

最终, n 为 8099, 是行溢出的临界点.

## 4	Dynamic 和 Compress 行格式

Dynamic 和 Compressed 行格式与 Compact 行格式类似, 主要区别在于行溢出数据的处理, 在 Dynamic 和 Compressed 行格式中:

- 当数据发生行溢出时, 所有字节都存储在其他页面中.
	
- 记录的真实数据处只存储其他页面的地址.

Compressed 行格式和 Dynamic 不同的一点是, Compressed行格式会采用压缩算法对页面进行压缩, 以节省空间.

---

# 📚 参考内容

